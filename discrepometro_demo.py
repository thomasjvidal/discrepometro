#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üéØ DISCREP√îMETRO DEMO - Vers√£o de Demonstra√ß√£o
=============================================

Esta √© uma vers√£o de demonstra√ß√£o que funciona com dados CSV para mostrar
como o sistema detecta compras/vendas sem nota atrav√©s da an√°lise CFOP.

üí° COMO USAR:
- Execute: python3 discrepometro_demo.py
- Usar√° os arquivos de exemplo j√° criados
"""

import pandas as pd
from supabase import create_client
from datetime import datetime

# Configura√ß√£o do Supabase
SUPABASE_URL = 'https://hvjjcegcdivumprqviug.supabase.co'
SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2ampjZWdjZGl2dW1wcnF2aXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2Nzg1MDAsImV4cCI6MjA2MzI1NDUwMH0.nerS1VvC5ebHOyHrtTMwrzdpCkAWpRpfvlvdlSspiG4'

supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

def classificar_cfop(cfop):
    """Classifica CFOP como ENTRADA (compra) ou SA√çDA (venda)"""
    cfop_str = str(cfop).replace(".", "").replace(" ", "")
    
    if len(cfop_str) >= 1:
        primeiro_digito = cfop_str[0]
        if primeiro_digito in ['1', '2', '3']:
            return 'ENTRADA'  # Compra com nota
        elif primeiro_digito in ['5', '6', '7']:
            return 'SAIDA'    # Venda com nota
    
    return 'DESCONHECIDO'

def ler_inventario_csv():
    """L√™ dados de invent√°rio do CSV"""
    print("üìä Lendo invent√°rio completo...")
    
    try:
        df = pd.read_csv('inventario_completo.csv')
        print(f"   ‚úÖ {len(df)} produtos de invent√°rio carregados")
        
        inventario = {}
        for _, row in df.iterrows():
            codigo = str(row['C√≥digo'])
            inventario[codigo] = {
                'produto': row['Produto'],
                'inicial': int(row['Estoque Inicial']),
                'final': int(row['Estoque Final'])
            }
        
        return inventario
    except Exception as e:
        print(f"   ‚ùå Erro: {e}")
        return {}

def ler_transacoes_fiscais():
    """L√™ transa√ß√µes fiscais dos CSVs dispon√≠veis"""
    print("üìä Lendo transa√ß√µes fiscais...")
    
    arquivos = ['test_fiscal.csv', 'dados_exemplo_fiscal.csv']
    todas_transacoes = {}
    
    for arquivo in arquivos:
        try:
            print(f"   üîç Processando: {arquivo}")
            df = pd.read_csv(arquivo)
            
            for _, row in df.iterrows():
                codigo = str(row['Mercadoria - C√≥digo'])
                quantidade = float(row['Mercadoria - Qtde'])
                cfop = str(row['CFOP'])
                produto = str(row['Mercadoria - Descri√ß√£o'])
                
                tipo_movimento = classificar_cfop(cfop)
                
                if codigo not in todas_transacoes:
                    todas_transacoes[codigo] = {
                        'produto': produto,
                        'entradas': 0,
                        'saidas': 0,
                        'cfops': []
                    }
                
                if tipo_movimento == 'ENTRADA':
                    todas_transacoes[codigo]['entradas'] += quantidade
                elif tipo_movimento == 'SAIDA':
                    todas_transacoes[codigo]['saidas'] += quantidade
                
                todas_transacoes[codigo]['cfops'].append(cfop)
            
            print(f"   ‚úÖ {arquivo}: {len(df)} registros processados")
            
        except Exception as e:
            print(f"   ‚ö†Ô∏è Erro em {arquivo}: {e}")
    
    print(f"   üìà Total: {len(todas_transacoes)} produtos √∫nicos")
    return todas_transacoes

def calcular_discrepancias(inventario, transacoes):
    """Calcula discrep√¢ncias usando a f√≥rmula solicitada"""
    print("\nüßÆ APLICANDO A F√ìRMULA DE C√ÅLCULO...")
    print("   üìê esperado = estoque_inicial + entradas - saidas")
    
    resultados = []
    
    # Combinar todos os produtos
    todos_produtos = set()
    todos_produtos.update(inventario.keys())
    todos_produtos.update(transacoes.keys())
    
    for codigo in todos_produtos:
        # Dados do invent√°rio
        dados_inv = inventario.get(codigo, {'inicial': 0, 'final': 0, 'produto': f'PRODUTO_{codigo}'})
        
        # Dados das transa√ß√µes
        dados_tx = transacoes.get(codigo, {'entradas': 0, 'saidas': 0, 'produto': f'PRODUTO_{codigo}', 'cfops': []})
        
        # Valores para c√°lculo
        estoque_inicial = dados_inv['inicial']
        estoque_final = dados_inv['final']
        entradas = dados_tx['entradas']
        saidas = dados_tx['saidas']
        
        # üßÆ F√ìRMULA PRINCIPAL (conforme solicitado)
        estoque_esperado = estoque_inicial + entradas - saidas
        
        # Calcular diferen√ßa
        diferenca = abs(estoque_final - estoque_esperado)
        
        # Determinar status (margem de 1 unidade)
        if diferenca <= 1:
            status = 'OK'
            discrepancia_tipo = 'Sem Discrep√¢ncia'
        else:
            status = 'ERRO'
            if estoque_final > estoque_esperado:
                discrepancia_tipo = 'Estoque Excedente'
            else:
                discrepancia_tipo = 'Estoque Faltante'
        
        # Nome do produto
        produto_nome = dados_inv.get('produto') or dados_tx.get('produto')
        
        # Mostrar c√°lculo detalhado para os primeiros produtos
        if len(resultados) < 3:
            print(f"\n   üìù Exemplo de c√°lculo - {produto_nome}:")
            print(f"      üî¢ Inicial: {estoque_inicial}")
            print(f"      ‚¨ÜÔ∏è  Entradas: {entradas}")
            print(f"      ‚¨áÔ∏è  Sa√≠das: {saidas}")
            print(f"      üéØ Esperado: {estoque_inicial} + {entradas} - {saidas} = {estoque_esperado}")
            print(f"      üì¶ Real: {estoque_final}")
            print(f"      ‚ùì Diferen√ßa: {diferenca}")
            print(f"      ‚úÖ Status: {status}")
        
        # Formatar dados conforme schema da tabela analise_discrepancia
        resultado = {
            'produto': produto_nome,
            'codigo': codigo,
            'cfop': ', '.join(dados_tx.get('cfops', [])) if dados_tx.get('cfops') else None,
            'valor_unitario': 0.0,  # N√£o temos dados de valor por enquanto
            'valor_total': 0.0,     # N√£o temos dados de valor por enquanto
            'entradas': int(entradas),
            'saidas': int(saidas),
            'est_inicial': int(estoque_inicial),
            'est_final': int(estoque_final),
            'est_calculado': int(estoque_esperado),
            'discrepancia_tipo': discrepancia_tipo,
            'discrepancia_valor': int(diferenca),
            'observacoes': f"F√≥rmula: {estoque_inicial} + {entradas} - {saidas} = {estoque_esperado}. Status: {status}",
            'ano': 2024,
            'user_id': None
        }
        
        resultados.append(resultado)
    
    # Estat√≠sticas
    total = len(resultados)
    ok_count = sum(1 for r in resultados if r['discrepancia_tipo'] == 'Sem Discrep√¢ncia')
    erro_count = total - ok_count
    
    print(f"\n   üìä RESULTADO DA AN√ÅLISE:")
    print(f"      üî¢ Total analisado: {total} produtos")
    print(f"      ‚úÖ OK (diferen√ßa ‚â§ 1): {ok_count} produtos")
    print(f"      ‚ùå ERRO (diferen√ßa > 1): {erro_count} produtos")
    
    return resultados

def mostrar_relatorio_detalhado(resultados):
    """Mostra relat√≥rio detalhado das discrep√¢ncias"""
    print("\nüìã RELAT√ìRIO DETALHADO DE DISCREP√ÇNCIAS")
    print("=" * 80)
    
    erros = [r for r in resultados if r['discrepancia_tipo'] != 'Sem Discrep√¢ncia']
    
    if not erros:
        print("‚úÖ PARAB√âNS! Nenhuma discrep√¢ncia significativa encontrada!")
        print("   Todos os produtos est√£o dentro da margem de 1 unidade.")
        return
    
    print(f"‚ùå ENCONTRADAS {len(erros)} DISCREP√ÇNCIAS:")
    print()
    
    for i, erro in enumerate(erros, 1):
        print(f"{i}. {erro['produto']} (C√≥digo: {erro['codigo']})")
        print(f"   üìê C√°lculo: {erro['est_inicial']} + {erro['entradas']} - {erro['saidas']} = {erro['est_calculado']}")
        print(f"   üì¶ Estoque Real: {erro['est_final']}")
        print(f"   ‚ö†Ô∏è  Diferen√ßa: {erro['discrepancia_valor']} unidades")
        print(f"   üè∑Ô∏è  CFOPs usados: {erro['cfop']}")
        print()
        
        # Interpreta√ß√£o da discrep√¢ncia
        if erro['discrepancia_tipo'] == 'Estoque Excedente':
            print(f"   üí° INTERPRETA√á√ÉO: Estoque maior que esperado")
            print(f"      Poss√≠vel COMPRA SEM NOTA de {erro['discrepancia_valor']} unidades")
        elif erro['discrepancia_tipo'] == 'Estoque Faltante':
            print(f"   üí° INTERPRETA√á√ÉO: Estoque menor que esperado")
            print(f"      Poss√≠vel VENDA SEM NOTA de {erro['discrepancia_valor']} unidades")
        print("-" * 80)

def salvar_no_supabase(resultados):
    """Salva resultados no Supabase na tabela correta"""
    if not resultados:
        print("‚ö†Ô∏è Nenhum resultado para salvar")
        return
    
    try:
        print(f"\nüíæ Salvando {len(resultados)} registros no Supabase...")
        
        # Limpar dados anteriores na tabela correta
        supabase.table('analise_discrepancia').delete().neq('id', 0).execute()
        print("   üóëÔ∏è Dados anteriores limpos")
        
        # Inserir novos dados
        supabase.table('analise_discrepancia').insert(resultados).execute()
        print(f"   ‚úÖ {len(resultados)} registros salvos com sucesso!")
        
    except Exception as e:
        print(f"   ‚ùå Erro ao salvar: {e}")

def main():
    """Executa a demonstra√ß√£o do Discrep√¥metro"""
    
    print("üéØ DISCREP√îMETRO DEMO - DEMONSTRA√á√ÉO")
    print("=" * 60)
    print("üìñ Este demo mostra como detectar compras/vendas sem nota")
    print("   atrav√©s da an√°lise de CFOPs vs estoque real")
    print()
    
    # Ler dados
    inventario = ler_inventario_csv()
    transacoes = ler_transacoes_fiscais()
    
    if not inventario or not transacoes:
        print("‚ùå Erro: Dados insuficientes para an√°lise")
        return
    
    # Calcular discrep√¢ncias
    resultados = calcular_discrepancias(inventario, transacoes)
    
    # Mostrar relat√≥rio
    mostrar_relatorio_detalhado(resultados)
    
    # Salvar no Supabase
    salvar_no_supabase(resultados)
    
    print("\nüéâ DEMONSTRA√á√ÉO CONCLU√çDA!")
    print("   üìä Dados salvos na tabela 'analise_discrepancia' do Supabase")
    print("   üîç Agora voc√™ pode visualizar os resultados no seu dashboard")

if __name__ == "__main__":
    main() 